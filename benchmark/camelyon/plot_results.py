import argparse
from pathlib import Path

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
from scipy import stats

# use color blind colors
plt.style.use("tableau-colorblind10")

DEFAULT_VALUES = {
    "n_rounds": 2,
    "sub_sampling": 1,
    "n_local_steps": 10,
    "batch_size": 32,
    "num_workers": 0,
}


def plot_linear_regression(data: pd.DataFrame, out_file: Path):
    """Generates and save as `out_file` a matplotlib figure of `data.connectlib_time.values` in function of
    `data.connectlib_time.values`. A linear regression is fit between those two features. Both line and equation
    are displayed.

    Args:
        data (pd.DataFrame): Must contains
        out_file (Path): File path to save the figure.
    """

    x = data.pure_torch_time.values
    y = data.connectlib_time.values

    if len(x) > 1:

        xmin = 0
        xmax = max(max(x), max(y) * 1.1)

        # regression part
        slope, intercept, r_value, _, _ = stats.linregress(x, y, alternative="greater")

        x_line = np.append(x, np.array([xmin, xmax]))
        x_line.sort()

        line = slope * x_line + intercept

        plt.gca().set_aspect("equal", adjustable="box")

        plt.xlabel("pure_torch torch computation time (s)")
        plt.ylabel("Connectlib computation time (s)")

        plt.plot(
            x_line,
            line,
            "g",
            label="y = {:.2f}x + {:.2f}   r = {:.2f}".format(slope, intercept, r_value),
        )

        plt.scatter(x, y, color="b", s=3.5)
        plt.legend(fontsize=9)

        plt.savefig(out_file)

    plt.close()


def plot_parameter(parameter: str, data: pd.DataFrame, out_file: Path):
    """Plot the connectlib and torch times when making one parameter
    change.

    Args:
        parameter (str): parameter that changes
        data (pd.DataFrame): data to plot
        out_file (Path): file where we save the figure
    """
    data.sort_values(by=parameter)
    x = data[parameter].values
    if len(x) > 1:
        torch_line = data.pure_torch_time.values
        connectlib_line = data.connectlib_time.values

        plt.plot(
            x,
            torch_line,
            label="torch",
            linestyle="--",
            marker="o",
            color="r",
        )
        plt.plot(
            x,
            connectlib_line,
            label="connectlib",
            linestyle="-",
            marker="d",
            color="k",
        )
        plt.xlabel(f"{parameter}")
        plt.ylabel("Computation time (s)")
        plt.legend(fontsize=9)
        plt.savefig(out_file)
    plt.close()


def plot_parameters(results: pd.DataFrame, folder: Path):
    """Plot the connectlib vs torch execution time when varying one parameter.

    Args:
        results (pd.DataFrame): _description_
        folder (Path): _description_
    """
    for parameter in DEFAULT_VALUES.keys():
        other_parameters = [k for k in DEFAULT_VALUES.keys() if k != parameter]
        query = " & ".join([f"{other_param}=={DEFAULT_VALUES[other_param]}" for other_param in other_parameters])
        parameter_results = results.query(query)

        plot_parameter(
            parameter=parameter,
            data=parameter_results,
            out_file=folder / f"parameter_{parameter}.png",
        )


def plot_results(results: pd.DataFrame, folder: Path):
    """Generates the following plots, connectlib execution time in function of pure torch execution time for
    different kind of experiments.

    Args:
        results (pd.DataFrame): Results generated by the benchmark.py file.
        folder (Path): The folder where to save the generated plots.
    """
    n_rounds_cond = results["n_rounds"] == 11
    sub_sampling_cond = results["sub_sampling"] == 1
    n_local_steps_cond = results["n_local_steps"] == 50

    small_n_rounds_cond = results["n_rounds"] == 3
    small_n_local_steps_cond = results["n_local_steps"] == 10

    if len(results) <= 1:
        print("One or zero experiments ran, will not plot anything.")

    # Plot all
    plt.title("All experiments")

    plot_linear_regression(
        results,
        folder / "all.png",
    )

    # Plot for fixed number of rounds (11) and local steps (50)
    filtered_results = results[n_rounds_cond & n_local_steps_cond]

    plt.title(
        f"11 rounds, 50 local steps, sampling from {filtered_results.sub_sampling.min()} "
        f"to {filtered_results.sub_sampling.max()}."
    )

    plot_linear_regression(
        filtered_results,
        folder / "sampling.png",
    )

    # Plot for fixed number of rounds (3) and local steps (10)
    filtered_results = results[small_n_rounds_cond & small_n_local_steps_cond]
    plt.title(
        f"3 rounds, 10 local steps, sampling from {filtered_results.sub_sampling.min()} "
        f"to {filtered_results.sub_sampling.max()}."
    )

    plot_linear_regression(
        filtered_results,
        folder / "small_sampling.png",
    )

    # Plot for fixed number of steps (50) and subsampling (1)
    filtered_results = results[sub_sampling_cond & n_local_steps_cond]
    plt.title(
        "Rounds from "
        f"{filtered_results.n_rounds.min()} to {filtered_results.n_rounds.max()}, 50 local steps, whole dataset"
    )

    plot_linear_regression(
        filtered_results,
        folder / "rounds.png",
    )

    # Plot for fixed number of steps (10) and subsampling (1)
    filtered_results = results[sub_sampling_cond & small_n_local_steps_cond]

    plt.title(
        "Rounds from "
        f"{filtered_results.n_rounds.min()} to {filtered_results.n_rounds.max()}, 11 local steps, whole dataset"
    )

    plot_linear_regression(
        filtered_results,
        folder / "small_rounds.png",
    )

    # Fixed subsampling (1) and number of rounds (50)
    filtered_results = results[sub_sampling_cond & n_rounds_cond]

    plt.title(
        "Whole dataset, 50 rounds, number of steps from "
        f"{filtered_results.n_local_steps.min()} to {filtered_results.n_local_steps.max()}."
    )

    plot_linear_regression(
        filtered_results,
        folder / "local_steps.png",
    )

    # Fixed subsampling (1) and number of rounds (10)
    filtered_results = results[sub_sampling_cond & small_n_rounds_cond]

    plt.title(
        "Whole dataset, 11 rounds, number of steps from "
        f"{filtered_results.n_local_steps.min()} to {filtered_results.n_local_steps.max()}."
    )

    plot_linear_regression(
        filtered_results,
        folder / "small_local_steps.png",
    )

    # Small times
    filtered_results = results[results.pure_torch_time < 5 * 60]

    plt.title("Torch execution time < 5 minutes")

    plot_linear_regression(
        filtered_results,
        folder / "small_times.png",
    )

    # Medium times
    filtered_results = results[(results.pure_torch_time >= 5 * 60) & (results.pure_torch_time < 60 * 60)]

    plt.title("Torch execution time from 5 to 60 minutes")

    plot_linear_regression(
        filtered_results,
        folder / "medium_times.png",
    )

    # Big times
    filtered_results = results[results.pure_torch_time >= 60 * 60]

    plt.title("Torch execution time > 60 minutes")

    plot_linear_regression(
        filtered_results,
        folder / "big_times.png",
    )


if __name__ == "__main__":
    results_folder = Path(__file__).parent / "results"

    parser = argparse.ArgumentParser("CLI for plotting the results")
    parser.add_argument("-f", "--file", type=Path, default=results_folder / "results.json")
    parser.add_argument("-o", "--out", type=Path, default=results_folder)
    args = parser.parse_args()
    results_file = args.file
    out_folder = args.out

    out_folder.mkdir(exist_ok=True)
    results = pd.read_json(results_file, orient="index")
    plot_parameters(results=results, folder=out_folder)
    plot_results(results=results, folder=out_folder)
